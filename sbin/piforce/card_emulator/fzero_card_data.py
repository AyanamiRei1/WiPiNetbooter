#!/usr/bin/env python3
import struct
import codecs
import sys
import os
import random
import shutil
import csv

fontdict = {}

with open('/var/log/printdata/fzfontslots', newline='') as csvfile:
    fontreader = csv.reader(csvfile, delimiter=',')
    for row in fontreader:
        fontdict[row[0]] = row[1]

printrefdict = {'07FFE078001E83FFC1BDB6FDB1B6F9BBB6CDB5B6CDB5B6F9B19CC5B19CC5BD9CFD83FFC178001E5FFFFA6B00D65500AA6B00D65500AA6B00D65500AA6B00D65500AA6B00D67FFFFE':'a','0000000000000000000000000000000000007E7E7E7E7E7E0606060E0E0E1C1C1C181818181818181818000000000000000000000000000000000000000000000000000000000000':'b','00820040860020C41818EE300CEEE006FFC007FFC657E7FC3FE7F81FE7F00FE7F007E7F81FE7FFFFE7F817E7F007E7F00FE7F81FFFDC1DFF8621FFC0419CE0018C30010808020800':'c','0000000000000000000000000000000000007E3C3C7E7E7E6066667C66667E66660666667E7E7E7C3C3C000000000000000000000000000000000000000000000000000000000000':'d','007E00018180067E60098190127E4825E7A44B67D256E7EAA1C3E5A80015AAAAF5AB55F5ABABF5AB95F5AF1AF5A73DE5567E6A4BFFD225FFA4127E48098190067E60018180007E00':'e','7FFFFE7FFFFE32802C3FFFFC7FFFFEFFC3FFDF81FBDF3CFBDF3FFBDF83FBDFC1FBDFFCFB7F3CFE3F81FC0FC3F00FFFF007FFE003FFC000D300007E00007E0000D30007FFE00DBDB0':'f','01FF802324C46524A6A524A5A90095A8FF15998199813C81C342C37FBDFE3F66FC014E800156803D7EBC43BDC2814281993C99B9819DB8FF1DAD00B56524A62724E403FFC001FF80':'g','00FF000381C00E7E7019E798373CEC2C24346A3C5659249AD0BD0BB0660DBFC3FDAA8155AA8155BFC3FDB0660DD0BD0B59249A6A3C562C2434373CEC19E7980E7E700381C000FF00':'h','00820040860020C41818EE300CEEE006FFC007FFC657C3FC3F81F81F99F00F3CF0073CF81F00FFFF00F8173CF0073CF00F3CF81FFFDC1DFF8621FFC0419CE0018C30010808020800':'i','00FF000381C00E3C7018C318333CCC24C3246900964A0052D4FF2B94FF29A8C315A80715A80E15A81C15941829D4182B4A185269009624C324333CCC18C3180E3C700381C000FF00':'j','7FFFFE7FFFFE32802C3FFFFC7FFFFEFF81FFDF00FBDF3CFBDF3CFBDF00FBDF00FBDF3CFB7F3CFE3F3CFC0F3CF00FFFF007FFE003FFC000D300007E00007E0000D30007FFE00DBDB0':'k','03FFC00C003010000821FF8447FFE24F3CF29E42799C813994812994C3298C7E314A3C524700E223FFC430FF0C38001C2F00F413FFC808FF120700E204FF0402003801FFE000FF80':'l','00FF000381C00E7E7019C398373CEC2CFF346BFFD65B00DAD700EBB73FEDAF3FF5AF01F5AF00F5AFFCF5B73CEDD700EB5B81DA6BFFD62CFF34373CEC19C3980E7E700381C000FF00':'m','00820040860020C41818EE300CEEE006FFC007FFC657C3FC3F81F81F99F00F3CF0073CF81F00FFFF00F8173CF0073CF00F3CF81FFFDC1DFF8621FFC0419CE0018C30010808020800':'n','07FFE078001E87FFE1B8421DA03C05A318C5A4993DA7F93DA418C5A33C05B8421D87FFE178001E7FFFEA7F00D67F00AA7F00D67F00AA7F00D67F00AA7F00D67F00AA7F00D67FFFFE':'o','00820040860020C41818EE300CEEE006FFC007FFC65724FC3F00F81F00F00F24F00724F81F24FFFF24F81724F00724F00F24F81FFFDC1DFF8621FFC0419CE0018C30010808020800':'p','0000003FFFFC6000064FFFF250000A53FFCA54002A54002A55DB2A55DB2A54DB2A54DB2A54DFAA54DFAA54C32A54C32A54002A54002A53FFCA50000A4FFFF26000067FFFFE3FFFFC':'q','0F00F010C3082F24F45F99FA6EC376114288112488912489DF24FBAE24759042094F81F22000041F3CF8027E4004C32004BD200542A00542A00542A0053CA002BD4001428000C300':'r','0000003FFFFC6000064FFFF250000A53FFCA54002A54002A55DFAA55DFAA54D82A54DF2A54DFAA54C1AA54DFAA54DF2A54002A54002A53FFCA50000A4FFFF26000067FFFFE3FFFFC':'s','0000000000000000000000000000000000007C7E3C7E7E7E0660663E7C667C7E666006667E7E7E7E7C3C000000000000000000000000000000000000000000000000000000000000':'t','000000000000000000000000000000000000038780038FC0018CC0018CC0018CC0018CC0018FC0018780000000000000000000000000000000000000000000000000000000000000':'u','00FF000381C00E3C7018C318333CCC24C3246900964A7E52D4FF2B94C329A8C315A8FF15A8FF15A8C31594C329D4FF2B4A7E5269009624C324333CCC18C3180E3C700381C000FF00':'v','00FF000381C00E3C7018C318333CCC24C3246900964A7E52D4FF2B94C329A8C315A8FF15A87F15A8031594C329D4FF2B4A7E5269009624C324333CCC18C3180E3C700381C000FF00':'w','60180690240990240960180671FF8E57E7EA5FC3FA4F81F240180270240E4924924AA5527ABD5E7399CE3FFFFC3FFFFC2000043FFFFC2000047FFFFE4924924924927FFFFE7FFFFE':'x','00000000000000000000000000000000000038787838FCFC18CCCC18CCCC18CCCC18CCCC18FCFC187878000000000000000000000000000000000000000000000000000000000000':'y','07FFE0180218210104400002666D9AA48955A6ED55A4A955B64D59800003800003ADAAD1800001B7575D80000185DB51C00001DBB6A9800001AF55E9800001800161FFFFFFFFFFFF':'z','3DFFBC7EE77EDF5AFBE9BD97F6BD6FEB3CD76D99B6B6BD6DDB81DBE03C07DD66BBBF42FDBF42FDDD66BBE03C07DB81DBB6BD6D6D99B6EB3CD7F6BD6FE9BD97DF5AFB7EE77E3DFFBC':'A','00FF00010080023C4004FF2009C390133CC8165668248B242D05B4298A9429559429AB9425FFA434FF2C127E48193C984CC332464A62A34AC5B34ACD9F4AF9404A027FDBFE7FDBFE':'B','03FFFF0FFFFF1FFFFF1FFFFF3FFFFF3F870E3F02043F32643F32643F3E643F3E643F3E643F3E643F3E643F3E643F32643F32643F02043F870C3FFFFF1FFFFF1FFFFF0FFFFF03FFFF':'C','00FF000381C00E7E7019C398373CEC2CFF346BFFD65BC7DAD7C7EBB7E7EDAFE7F5AFE7F5AFE7F5AFE7F5B7E7EDD7C3EB5BC3DA6BFFD62CFF34373CEC19C3980E7E700381C000FF00':'D','00820040860020C41818EE300CEEE006FFC007FFC6573CFC3F1CF81F0CF00F04F00720F81F30FFFF38F8173CF0073CF00F3CF81FFFDC1DFF8621FFC0419CE0018C30010808020800':'E','00FF000381C00E7E7019C398373CEC2CFF346BFFD65B81DAD700EBB73CEDAF3FF5AF01F5AF00F5AF3CF5B73CEDD700EB5B81DA6BFFD62CFF34373CEC19C3980E7E700381C000FF00':'F','7FFFFE7FFFFE32802C3FFFFC7FFFFEFE7E7FDC3C3BD9999BD9F9FBDC7C7BDE3E3BDF9F9B79999E3C3C3C0E7E700FFFF007FFE003FFC000D300007E00007E0000D30007FFE00DBDB0':'G','00000000000000000000000000000000000007C3C007E7E000666003E66003E66000666007E7E007C3C0000000000000000000000000000000000000000000000000000000000000':'H','00FF000381C00E7E7019C3983700EC2C7E346A3C5659189AD0990BB45A2DA63C65A7FFE5A7FFE5A63C65B45A2DD0990B59189A6A3C562C7E343700EC19C3980E7E700381C000FF00':'I','FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF070CF80204F09264F39264F39264F39264F39264F09204F0920CF3927CF3927CF3927CF3927C10927E18FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF':'J','00FF000381C00E7E7019C398373CEC2CFF346BFFD65B33DAD733EBB733EDAF33F5AF33F5AF33F5AF00F5B700EDD7F3EB5BF3DA6BFFD62CFF34373CEC19C3980E7E700381C000FF00':'K','FFFFF0FFFFFCFFFFFEFFFFFEFFFFFF40C33F40833FF39F3FF39F3FF39F3FF39F3F73833F73833FF39F3FF39F3FF39F3FF39FFF73833F73C33FFFFFFFFFFFFEFFFFFEFFFFFCFFFFF0':'L','00820040860020C41818EE300CEEE006FFC007FFC657C3FC3F81F81F18F00F3CF0073FF81F38FFFF38F8171CF00780F00FC2F81FFFDC1DFF8621FFC0419CE0018C30010808020800':'M','3FC3FC47BDE2BB66DDBCDB3DBEDB7DDEFF7BED81B7E17E87DCC33BBDBDBD6566A65D42BA5D42BA6566A6BDBDBDDCC33BE17E87ED81B7DEFF7BBEDB7DBCDB3DBB66DD47BDE23FC3FC':'N','001F000020800040400480200494200EAA10045508202A88201F847000D423804A0C605610104A254855CAA64B9551D5AAA80BD55555AAAAABD55555AAAAABD55555FFFFFEFFFFFC':'O','803C01486612244A2410560807CAA00C15501AAAA83555F428AB1C38D51C1CAB380FFFF007A5E001248005FFA009FF9011428825C3A409C3901181882381C447FFE20955700FFFF0':'P','07FFE078001E83FFC1BD00BDA23C45A44225A8FF15900009A1FF85A300C5BE007D83FFC1F8001F47FFF64155AA41FF564155AA41FF564155AA41FF564155AA41FF564155AA7FFFFE':'Q','01FF8002004004FF20090090127E4824812449009252004A55CF2A55DFAA54D9AA54D9AA54D9AA54D9AA54DFAA54CF2A52004A490092648126327E4C1900980CFF3006006003FFC0':'R','00001F00007F0000FF0000FF0001FC0001F80001F90001F90001F90001F90001F90001F80001F80001F90001F90001F90001F90001F90001F80001FC0000FF0000FF00007F00001F':'S','000000001800001800002400002C00004600004A00008700FF0BFF4005563AAAAC0D5FF006AAA0035FC002AAC003FFC002AAC003FFC002E6C007C3E00700E00E00700C0030080010':'T','00820040860020C41818EE300CEEE006FFC007FFC65700FC3F00F81FF8F00FF1F007E3F81FC7FFFF8FF8171FF00700F00F00F81FFFDC1DFF8621FFC0419CE0018C30010808020800':'U','00FF000381C00E7E7019C398373CEC2CFF346BFFD65B81DAD700EBB73CEDAFFCF5AFC0F5AF81F5AF1FF5B73FEDD700EB5B00DA6BFFD62CFF34373CEC19C3980E7E700381C000FF00':'V','01FF8002004004FF20090090127E4824812449009252004A55DF2A55DFAA54C1AA54CFAA54DF2A54D82A54DFAA54DFAA52004A490092648126327E4C1900980CFF3006006003FFC0':'W','FFFFF0FFFFFCFFFFFEFFFFFE3870FF30307FF3327FF3323FF3333FF3333FF3333F33333F33333FF3333FF3333FF3333FF3323FF3327F33307F3330FFFFFFFEFFFFFEFFFFFCFFFFF0':'X','007E00004200005E00005E0000FF00014280015E80015E80035EC00D5EB015FFA82D42B4F55AAFAD42B5B542ADAD42B5B542ADAD42B5B542ADAD42B5BF5AFDBFC3FDE0FF07E07E07':'Y','3FF7FC7F00FEBCF73DD3F7CBEFC3F7E73CE7DADB5BDDFFBB3AC35C8BBDD1B566ADB742EDB742EDB566AD8BBDD13BC3DCDD7EBBDEDB7BED3CB7EBC3D7F3F7CFECF7375F00FA3FF7FC':'Z','01C380222444641826A49925A89915A8A515993C99818181C300C37F81FE3CFF3C007E00007E003C813C4300C2818181993C99B8A51DB8991DAC9935641826263C6403E7C001C380':'0','03EFC00408200BEFD011248824A5244A66526500A6B33CCDA84215A4BD25BD42BD014E80E17687B97E9DACBD35A84215923C496700E60E667034E72C1124880BEFD004082003EFC0':'1','3C243C7BFFDEF7E7EFEE1877DDE7BBBAFF5D7742EE6BBDD66D42B66EBD76ED66B75542AA5542AAED66B76EBD766D42B66BBDD67742EEBAFF5DDDE7BBEE1877F7E7EF7BFFDE3C243C':'2','00FF000381C00E7E7019C398373CEC2CFF346BFFD65B01DAD700EBB7FCEDAFFCF5AF80F5AF80F5AFFCF5B7FCEDD700EB5B01DA6BFFD62CFF34373CEC19C3980E7E700381C000FF00':'3','00FF000381C00E7E7019DB983718EC2F18F46B18D65B99DAD1FF8BB1FF8DA21845BFFFFDBFFFFDA21845B1FF8DD1FF8B5B99DA6B18D62F18F43718EC19DB980E7E700381C000FF00':'4','000000000000000000000000000000000000E7C70EE7CF9F660D9B678D9B67CD9B60CD9B67CF9F67870E000000000000000000000000000000000000000000000000000000000000':'5','0000003FFFFC6000064FFFF250000A53FFCA5581AA55C2AA55E4AA55F8AA55F0AA55F0AA55F0AA55F0AA54F12A54722A54342A54182A53FFCA50000A4FFFF26000067FFFFE3FFFFC':'6','7FFFFE7FFFFE32802C3FFFFC7FFFFEFF3CFFDF3CFBDF18FBDF00FBDF24FBDF24FBDF3CFB7F3CFE3F3CFC0F3CF00FFFF007FFE003FFC000D300007E00007E0000D30007FFE00DBDB0':'7','01FF8002004004FF20090090127E4824812449009252004A54E72A54E72A54632A54632A54632A54632A54632A54632A52004A490092648126327E4C1900980CFF3006006003FFC0':'8','0000003FFFFC6000064FFFF250000A53FFCA54002A54002A55DF2A55DFAA54C1AA54DFAA54DFAA54C1AA54DFAA54DF2A54002A54002A53FFCA50000A4FFFF26000067FFFFE3FFFFC':'9'}

def replace_line(file_name, line_num, text):
    lines = open(file_name, 'r').readlines()
    lines[line_num] = text
    out = open(file_name, 'w')
    out.writelines(lines)
    out.close()

def process_line(linedata, fontdict, printrefdict):
    iconarray = []
    line = linedata.replace('2020','')
    lookup = 0
    linesplit = line.split('1B67')
    for fontslot in linesplit:
        for k,v in fontdict.items():
            if (k == fontslot and k != ''):
                lookup = v
                break
        for k,v in printrefdict.items():
            if (lookup != 0 and lookup == k):
                printchar = v
                iconarray.append(printchar)
                lookup = 0
                break
    if iconarray:
        return ''.join(iconarray)

rawprintfile = sys.argv[1]
path = '/var/www/html/cards/fzero/'
phppath = path+os.path.basename(rawprintfile)+".php"
delta = "false"

licensestart = 22
namestart = 64
rankstart = 26
citystart = 88

if not os.path.exists(phppath) and os.path.getsize(rawprintfile) < 120:

    with open(rawprintfile,"r") as f:

        if f.read(2) == '05':
            licensestart = licensestart+2
            namestart = namestart+2
        f.seek(licensestart)
        license = f.read(38)
        f.seek(namestart)
        name = f.read(32)

    f.close()

    namestring = name.replace('2020','20')
    shiftjistext = codecs.decode(namestring,'hex')
    driver = codecs.decode(shiftjistext,'shift-jis')
    drivername = ''
    for c in driver:
        if (ord(c)>256):
            newc = chr(ord(c)-65248)
            drivername+=newc
        else:
            drivername+=c

    license = codecs.decode(license,'hex').decode()
    cardimage = random.choice(os.listdir("/var/www/html/cardimages/fzero"))
    with open("card_output","w") as fi:

        fi.write('<?php'+'\n')
        fi.write('$license="'+license+'";\n')
        fi.write('$driver="'+drivername+'";\n')
        fi.write('$rank1="";\n')
        fi.write('$rank2="";\n')
        fi.write('$rank3="";\n')
        fi.write('$rank4="";\n')
        fi.write('$rank5="";\n')
        fi.write('$mute="";\n')
        fi.write('$aero="";\n')
        fi.write('$outer="";\n')
        fi.write('$port="";\n')
        fi.write('$light="";\n')
        fi.write('$green="";\n')
        fi.write('$card="'+cardimage+'";\n')
        fi.write('?>'+'\n')

    shutil.move("./card_output", phppath)

if os.path.exists(phppath) and 120 < os.path.getsize(rawprintfile) < 320:

    phpfile = open(phppath)
    phplines = phpfile.readlines()

    with open(rawprintfile,"r") as f:

        if f.read(2) == '05':
            rankstart = rankstart+2
        f.seek(rankstart)
        rankinfo = f.read()

    f.close()

    rankraw = rankinfo.split("0D")
    rankdata = rankraw[:5]
    i = 1
    for rankline in rankdata:
        result = process_line(rankline, fontdict, printrefdict)
        if result:
            phpdata = ''.join(phplines[i+2].split('"')[1::2])+str(result)
        else:
            phpdata = ''.join(phplines[i+2].split('"')[1::2])
        replace_line(phppath, i+2, '$rank'+str(i)+'="'+phpdata+'";\n')
        i = i+1

    phpfile.close()

if os.path.exists(phppath) and os.path.getsize(rawprintfile) > 350:

    phpfile = open(phppath)
    phplines = phpfile.readlines()
    cityvalues = ['mute','aero','outer','port','light','green']

    with open(rawprintfile,"r") as f:

        if f.read(2) == '05':
            citystart = citystart+2
        f.seek(citystart)
        cityinfo = f.read()

    f.close()

    cityraw = cityinfo.split("0D")
    citydata = cityraw[:6]
    print(citydata)
    i = 0
    for cityline in citydata:
        result = process_line(cityline, fontdict, printrefdict)
        if result:
            if (result == '4'):
                phpdata = str(result)+''.join(phplines[i+8].split('"')[1::2])
            else:
                phpdata = ''.join(phplines[i+8].split('"')[1::2])+str(result)
        else:
            phpdata = ''.join(phplines[i+8].split('"')[1::2])
        replace_line(phppath, i+8, '$'+cityvalues[i]+'="'+phpdata+'";\n')
        print(phpdata)
        i = i+1

    phpfile.close()